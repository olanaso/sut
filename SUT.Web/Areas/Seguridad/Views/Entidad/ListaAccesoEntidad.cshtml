@model Sut.Entities.Entidad
@{
    ViewBag.Title = "Acceso a Entidades";
    ViewBag.Descripcion = "Asignación";
}

<div id="mensajes"></div>

<div class="row">
    <div class="col-xs-12">
        <div id="boxLista" class="box box-danger">
            <div class="box-body">

                <div class="col-sm-7 col-xs-12">

               
                    <a class="btn btn-success btn-sm" href="javascript:sut.Entidad.aceptar();"><i class="fa fa-check"></i> Agregar</a>
                    <table id="tblLista" class="table table-bordered table-striped table-hover"
                           data-pagesize="5000"
                           data-page="1"
                           data-totalrows="0"
                           data-function="sut.Entidad.listar"
                           data-paginator="paginator">
                        <thead>
                            <tr>
                                <th class="colAction">Nro.</th>
                                @*<th style="margin: 0.5rem;padding: 1rem;width: 10px">Gobierno</th>*@
                                <th style="margin: 0.5rem;padding: 1rem;">Sector</th>
                                <th style="margin: 0.5rem;padding: 1rem;">Departamento</th>
                                <th style="margin: 0.5rem;padding: 1rem;">Provincia</th>
                                @*<th style="margin: 0.5rem;padding: 1rem;">Código</th>*@
                                <th style="margin: 0.5rem;padding: 1rem;">Nombre</th>
                                <th style="margin: 0.5rem;padding: 1rem;">Acrónimo</th>
                                <th rowspan="2" class="colAction"></th>
                            </tr>
                            <tr>
                                <th><button class="btn btn-default btn-xs" title="Borrar Filtros" data-toggle="tooltip" data-placement="right"><i class="fa fa-filter"></i></button></th>
                                @*<th>@Html.DropDownList("filterGobierno", ViewBag.ListaGobierno as List<SelectListItem>, new { @id = "cbFilterGobierno", @class = "form-control input-sm" })</th>*@
                                <th>@Html.DropDownList("filterSector", ViewBag.ListaSector as List<SelectListItem>, new { @id = "cbFilterSector", @class = "form-control input-sm" })</th>
                                <th>@Html.DropDownList("filterDepartamento", ViewBag.ListaDepartamento as List<SelectListItem>, new { @id = "cbFilterDepartamento", @class = "form-control input-sm" })</th>
                                <th>@Html.DropDownList("filterProvincia", ViewBag.ListaProvincia as List<SelectListItem>, new { @id = "cbFilterProvincia", @class = "form-control input-sm" })</th>
                                @*<th><input id="txtFilterCodigo" type="text" class="form-control input-sm" /></th>*@
                                <th><input id="txtFilterNombre" type="text" class="form-control input-sm" /></th>
                                <th><input id="txtFilterAcronimo" type="text" class="form-control input-sm" /></th>
                                <th><input type="checkbox" onClick="toggle15(this)" /> </th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                        <tfoot>
                            <tr><td colspan="9"><div id="paginator"></div></td></tr>
                        </tfoot>
                    </table>
                </div>
                <div class="col-sm-5 col-xs-12">
                     
                    <a class="btn btn-danger btn-sm" href="javascript:sut.Entidad.quitar();"><i class="fa fa-check"></i> Quitar</a>
                    <table id="tblListaAsignado" class="table table-bordered table-striped table-hover"
                           data-pagesize="5000"
                           data-page="1"
                           data-totalrows="0"
                           data-function="sut.Entidad.listarAsignado"
                           data-paginator="paginator">
                        <thead>
                            <tr>
                                <th class="colAction">Nro.</th>
                                @*<th style="margin: 0.5rem;padding: 1rem;width: 10px">Gobierno</th>*@
                                @*<th style="margin: 0.5rem;padding: 1rem;">Sector</th>
                    <th style="margin: 0.5rem;padding: 1rem;">Departamento</th>
                    <th style="margin: 0.5rem;padding: 1rem;">Provincia</th>*@
                                @*<th style="margin: 0.5rem;padding: 1rem;">Código</th>*@
                                <th style="margin: 0.5rem;padding: 1rem;">Nombre</th>
                                <th style="margin: 0.5rem;padding: 1rem;">Acrónimo</th>
                                <th rowspan="2" class="colAction"></th>
                            </tr>
                            <tr>
                                <th><button class="btn btn-default btn-xs" title="Borrar Filtros" data-toggle="tooltip" data-placement="right"><i class="fa fa-filter"></i></button></th>
                                @*<th>@Html.DropDownList("filterGobierno", ViewBag.ListaGobierno as List<SelectListItem>, new { @id = "cbFilterGobierno", @class = "form-control input-sm" })</th>*@
                                @*<th>@Html.DropDownList("filterSector", ViewBag.ListaSector as List<SelectListItem>, new { @id = "cbFilterSector", @class = "form-control input-sm" })</th>
                    <th>@Html.DropDownList("filterDepartamento", ViewBag.ListaDepartamento as List<SelectListItem>, new { @id = "cbFilterDepartamento", @class = "form-control input-sm" })</th>
                    <th>@Html.DropDownList("filterProvincia", ViewBag.ListaProvincia as List<SelectListItem>, new { @id = "cbFilterProvincia", @class = "form-control input-sm" })</th>*@
                                @*<th><input id="txtFilterCodigo" type="text" class="form-control input-sm" /></th>*@
                                <th><input id="txtFilterNombre2" type="text" class="form-control input-sm" /></th>
                                <th><input id="txtFilterAcronimo2" type="text" class="form-control input-sm" /></th>
                                <th><input type="checkbox" onClick="toggle16(this)" /> </th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                        <tfoot>
                            <tr><td colspan="9"><div id="paginator"></div></td></tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<div style="position: fixed;right: 15px;top: 60px; margin-bottom: 0;z-index: 5;">
    <a href="javascript:sut.Entidad.salir('@Url.Content("~/Seguridad/Usuario/Lista")')" class="btn btn-danger"><i class="fa fa-arrow-left"></i> Volver</a>
</div>

<div class="modal fade" id="modal-ventana" data-backdrop="static" data-keyboard="false">
    <div id="ventana-container">

    </div>
</div>


@section Style {
    <style type="text/css">
        table#tblLista thead tr th {
            text-align: center;
        }

        table#tblLista tbody tr td[colspan="6"] {
            font-weight: bold;
            text-align: center;
        }

        #tblLista .colNro {
            width: 40px;
            text-align: center;
        }

        #tblLista .colAction {
            width: 30px;
        }

        #tblLista tfoot .pagination {
            margin: 0px 0px;
        }
    </style>
}

@section Script {
    <script>

        sut.Entidad = {

            listar: (page) => {
                table = $('#tblLista');
                var model = {

                    //'filtro.NivelGobiernoId': $('#cbFilterGobierno').val(),
                    'filtro.SectorId': $('#cbFilterSector').val(),
                    'filtro.DepartamentoId': $('#cbFilterDepartamento').val(),
                    'filtro.ProvinciaId': $('#cbFilterProvincia').val(),
                    //'filtro.Codigo': $('#txtFilterCodigo').val(),
                    'filtro.Nombre': $('#txtFilterNombre').val(),
                    'filtro.Acronimo': $('#txtFilterAcronimo').val(),
                    'filtro.TipoTupa': 1,
                    pageIndex: page,
                    pageSize: table.data('pagesize'),
                    usuarioId: @ViewBag.UsuarioID
                };
                $.ajax({
                    //url: "/Seguridad/Usuario/GetAllLikePagin",
                    url: '@Url.Content("~/Seguridad/Entidad/GetAllLikePaginDetalle")',
                    type: "GET",
                    data: model,
                    dataType: "json",
                    beforeSend: () => {
                        sut.wait.appendOverlay('#boxLista');
                    },
                    success: (data) => {
                        sut.wait.removeOverlay('#boxLista');
                        table.data('page', page);
                        table.data('totalrows', data.totalRows);
                        sut.Entidad.generar(data.lista);
                        if (data.totalRows == 0) $('#tblLista tbody').append("<tr><td colspan='6' class='text-center text-bold'>NO SE ENCONTRARON REGISTROS.</td></td>");


                    },
                    error: (data) => {
                        sut.error.show('mensajes', data.responseText);
                    },
                    statusCode: {
                        203: () => { window.location.reload(); }
                    }
                });
            },


            listarAsignado: (page) => {
                table = $('#tblListaAsignado');
                var model = {

                    //'filtro.NivelGobiernoId': $('#cbFilterGobierno').val(),
                    //'filtro.SectorId': $('#cbFilterSector').val(),
                    //'filtro.DepartamentoId': $('#cbFilterDepartamento').val(),
                    //'filtro.ProvinciaId': $('#cbFilterProvincia').val(),
                    //'filtro.Codigo': $('#txtFilterCodigo').val(),
                    'filtro.Nombre': $('#txtFilterNombre2').val(),
                    'filtro.Acronimo': $('#txtFilterAcronimo2').val(),
                    'filtro.TipoTupa': 1,
                    pageIndex: page,
                    pageSize: table.data('pagesize'),
                    usuarioId: @ViewBag.UsuarioID
                };
                $.ajax({
                    //url: "/Seguridad/Usuario/GetAllLikePagin",
                    url: '@Url.Content("~/Seguridad/Entidad/GetAllLikePaginDetalleAsignado")',
                    type: "GET",
                    data: model,
                    dataType: "json",
                    beforeSend: () => {
                        sut.wait.appendOverlay('#boxLista');
                    },
                    success: (data) => {
                        sut.wait.removeOverlay('#boxLista');
                        table.data('page', page);
                        table.data('totalrows', data.totalRows);
                        sut.Entidad.generarAsignado(data.lista);
                        if (data.totalRows == 0) $('#tblListaAsignado tbody').append("<tr><td colspan='6' class='text-center text-bold'>NO SE ENCONTRARON REGISTROS.</td></td>");


                    },
                    error: (data) => {
                        sut.error.show('mensajes', data.responseText);
                    },
                    statusCode: {
                        203: () => { window.location.reload(); }
                    }
                });
            },

            aceptar: function () {

                debugger;
                var inputs = $('#tblLista tbody tr td input:checked');
                var data = [];
                var cant = 0;
                if (inputs.length > 0) {
                    $.each(inputs, function (i, r) {
                        var v = $(r).val();
                        data.push({ EntidadId: v });

                        cant = cant + 1;
                    }); 

                   // fnAdd(data);
                }

                if (cant== 0) {
                    showNotification('top', 'right', 'Debe seleccionar entidades para agregar.', 2);
                    return;
                }
                 

                     $.ajax({
                    type: 'POST',
                     url: '@Url.Content("~/Seguridad/Entidad/GuardarAsignacion")',
                    data: { listaEnt: data, usuarioid:  @ViewBag.UsuarioID },
                    dataType: 'json',
                    beforeSend: function () {
                        $("#mensajes").hide();
                        sut.wait.appendOverlay('#boxLista');
                    },
                    complete: function () {

                    },
                    success: function (result) {
                        sut.wait.removeOverlay('#boxLista');
                        sut.Entidad.listar(1);
                        sut.Entidad.listarAsignado(1);
                    },
                    error: function (result) {
                        sut.error.show('mensajes', result.responseText);
                    }
                });


            },
               quitar: function () {

                debugger;
                   var inputs = $('#tblListaAsignado tbody tr td input:checked');
                   var data = [];
                   var cant = 0;
                if (inputs.length > 0) {
                    $.each(inputs, function (i, r) {
                        var v = $(r).val();
                        data.push({ EntidadId: v });
                        cant = cant + 1;
                    });
                   // fnAdd(data);
                }

                   if (cant == 0) {
                       showNotification('top', 'right', 'Debe seleccionar entidades para quitar.', 2);
                       return;
                   }

                     $.ajax({
                    type: 'POST',
                     url: '@Url.Content("~/Seguridad/Entidad/quitarAsignacion")',
                    data: { listaEnt: data, usuarioid:  @ViewBag.UsuarioID },
                    dataType: 'json',
                    beforeSend: function () {
                        $("#mensajes").hide();
                        sut.wait.appendOverlay('#boxLista');
                    },
                    complete: function () {

                    },
                    success: function (result) {
                        sut.wait.removeOverlay('#boxLista');
                        sut.Entidad.listar(1);
                        sut.Entidad.listarAsignado(1);
                    },
                    error: function (result) {
                        sut.error.show('mensajes', result.responseText);
                    }
                });


            },

            salir: function (expediente) {
                $(location).attr('href', expediente);
            },
            generar: (lista) => {
                debugger;
                var roltitulo = '';
                var table = $('#tblLista');
                var tabla = table.children('tbody');
                tabla.children('tr').remove();
                var rows = '';
                var numero = (table.data('pagesize') * table.data('page')) - table.data('pagesize');
                $.each(lista, (i, r) => {
                    rows += sut.string.format('<tr><td class="colNro" >{0}</td>', ++numero);
                    //rows += sut.string.format('<td>{0}</td>', r.NivelGobierno);
                    rows += sut.string.format('<td>{0}</td>', r.Sector);
                    rows += sut.string.format('<td>{0}</td>', r.Departamento);
                    rows += sut.string.format('<td>{0}</td>', r.Provincia);
                    //rows += sut.string.format('<td>{0}</td>', r.Codigo);
                    rows += sut.string.format('<td>{0}</td>', r.Nombre);
                    rows += sut.string.format('<td>{0}</td>', r.Acronimo);
                    rows += '<td>';
                    rows += '<div class="btn-group">';
                    rows += sut.string.format('<td style="text-align: center;"><input type="checkbox" title="Editar" id="CheckEditar{0}"  name="dinamico"  value="{2}" {1} /><input name="[{0}].Editar" type="hidden" value="{2}" /></td>', i, 0 ? 'checked' : '', r.EntidadId);
                    rows += '</div>';
                    rows += '</td>';
                    rows += '</tr>';
                });
                sut.pagination.update(table);
                tabla.append(rows);
            },
            generarAsignado: (lista) => {
                debugger;
                var roltitulo = '';
                var table = $('#tblListaAsignado');
                var tabla = table.children('tbody');
                tabla.children('tr').remove();
                var rows = '';
                var numero = (table.data('pagesize') * table.data('page')) - table.data('pagesize');
                $.each(lista, (i, r) => {
                    rows += sut.string.format('<tr><td class="colNro" >{0}</td>', ++numero);
                    //rows += sut.string.format('<td>{0}</td>', r.NivelGobierno);
                    //rows += sut.string.format('<td>{0}</td>', r.Sector);
                    //rows += sut.string.format('<td>{0}</td>', r.Departamento);
                    //rows += sut.string.format('<td>{0}</td>', r.Provincia);
                    //rows += sut.string.format('<td>{0}</td>', r.Codigo);
                    rows += sut.string.format('<td>{0}</td>', r.Nombre);
                    rows += sut.string.format('<td>{0}</td>', r.Acronimo);
                    rows += '<td>';
                    rows += '<div class="btn-group">';
                    rows += sut.string.format('<td style="text-align: center;"><input type="checkbox" title="Editar" id="CheckEditar{0}"  name="dinamico2" value="{2}" {1} /><input name="[{0}].Editar" type="hidden" value="{2}" /></td>', i, 0 ? 'checked' : '', r.EntidadId);
                    rows += '</div>';
                    rows += '</td>';
                    rows += '</tr>';
                });
                sut.pagination.update(table);
                tabla.append(rows);
            },


            editar: (id) => {
                $.ajax({
                    type: "GET",
                    //url: '/Seguridad/Entidad/Editar',
                    url: '@Url.Content("~/Seguridad/Entidad/Editar")',
                    data: { id: id, vertodo: 1 },
                    cache: false,
                    beforeSend: () => {
                        sut.wait.modal('ventana-container');
                        $('#modal-ventana').modal('show');
                    },
                    success: (data) => {
                        $('#ventana-container').html(data);
                    },
                    error: (result) => {
                        $('#modal-ventana').modal('hide');
                        sut.error.show('mensajes', result.responseText);
                    },
                    statusCode: {
                        203: () => { window.location.reload(); }
                    }
                });
            },
        };

        $(() => {
            sut.Entidad.listar(1);
            sut.Entidad.listarAsignado(1);

            $('#txtFilterNombre, #txtFilterAcronimo').keypress((e) => {
                var key = e.keyCode || event.keyCode;
                if (key == 13) sut.Entidad.listar(1);
            });


            $('#cbFilterSector').change((e) => {
                sut.Entidad.listar(1);
            });


            $('#cbFilterDepartamento').change((e) => {
                sut.Entidad.listar(1);
            });


            $('#txtFilterNombre2, #txtFilterAcronimo2').keypress((e) => {
                var key = e.keyCode || event.keyCode;
                if (key == 13) sut.Entidad.listarAsignado(1);
            });



            $('#cbFilterDepartamento').on('change', (e) => {

                $.ajax({
                    type: "POST",
                    //url: "/Seguridad/Entidad/GetProvincias",
                    url: '@Url.Content("~/Seguridad/Miembro/GetProvincias")',
                    data: { id: $('#cbFilterDepartamento').val() },
                    dataType: 'json',
                    beforeSend: function () {
                    },
                    complete: function () {
                    },
                    success: function (result) {

                        var sel = $('#cbFilterProvincia');
                        sel.find('option').remove();
                        $.each(result.data, (i, r) => {
                            sel.append($('<option></option>').attr('value', r.ProvinciaId).html(r.Nombre));
                        });

                    },
                    error: function (result) {
                        sut.error.show('msgEditar', result.responseText);
                    }
                });
            });

            $('#cbFilterProvincia').change((e) => {
                sut.Entidad.listar(1);
            });


        });

        function toggle15(source) {
            checkboxes = document.getElementsByName('dinamico');
            for (var i = 0, n = checkboxes.length; i < n; i++) {
                checkboxes[i].checked = source.checked;
            }
        }

        function toggle16(source) {
            checkboxes = document.getElementsByName('dinamico2');
            for (var i = 0, n = checkboxes.length; i < n; i++) {
                checkboxes[i].checked = source.checked;
            }
        }
    </script>
}